# 学習とテストの性能乖離問題 - 診断・解決パッケージ

**作成日**: 2025年11月11日  
**対象**: PPOエージェントの学習・テスト性能乖離問題

---

## 📊 問題の要約

**学習時**: 平均RT **7.46分**（良好）  
**テスト時**: 平均RT **20.88分**（悪い）  
**同じ日付で過学習を前提としているのに、3倍近い性能差**

→ PPOエージェントが全く学習していない可能性が高い

---

## 📁 提供ファイル一覧

### 1. 診断ツール（実行必須）

#### 🔴 最優先: debug_training_process.py
**目的**: 学習プロセスが正常に機能しているかを検証

```bash
python debug_training_process.py --config config.yaml --episodes 5
```

**検証項目**:
- ✅ バッファへのデータ蓄積
- ✅ PPOの更新実行
- ✅ **モデルパラメータの変化**（最重要）
- ✅ モデルの保存・読み込み

**期待される結果**:
```
❌ 【検証3】モデルパラメータの変化
   ActorもCriticもパラメータが変化していません！
   → 学習が全く機能していません
```

#### 🟡 次優先: debug_test_behavior.py
**目的**: テスト時の行動選択を分析

```bash
python debug_test_behavior.py \
    --model reinforcement_learning/experiments/ppo_training/ppo_20251110_182404/checkpoints/best_model.pth \
    --config config.yaml \
    --steps 50
```

**検証項目**:
- モデルパラメータのチェック
- 教師との行動一致率
- ランダム選択との比較

---

### 2. 分析レポート（必読）

#### 📘 総合診断レポート.md
- 問題の本質の説明
- 推定される根本原因（バッファサイズ不足）
- 診断結果のパターン別対応
- **即座に実行すべき対策**

#### 📗 診断実行ガイド.md
- 診断の実行手順
- 結果の解釈方法
- トラブルシューティング
- 報告フォーマット

#### 📙 問題分析と検証レポート.md
- コードレビュー結果
- 修正案の妥当性評価
- 仮説と検証方法

---

### 3. 修正コード例（参考）

#### trainer_evaluate_fix.py
- 評価メソッドの修正版
- force_teacher=Falseの適用

#### test_trained_model.py
- 独立したテストスクリプト
- 学習プロセスから独立した評価

#### README_問題解決ガイド.md
- 問題解決の全体フロー
- 段階的なアクションアイテム

---

## 🚀 即座に実行すべきこと

### ステップ1: 診断実行（最重要）

```bash
python debug_training_process.py --config config.yaml --episodes 5
```

**実行時間**: 約5-10分

**確認ポイント**:
1. バッファサイズが1024に到達するか
2. PPOの更新が実行されるか
3. **パラメータが変化するか**

### ステップ2: 結果の報告

以下の情報を報告してください：

```
【検証1】バッファへのデータ蓄積: ✅ or ❌
  最終バッファサイズ: XXX/1024

【検証2】PPOの更新実行: ✅ or ❌
  actor_loss: X.XXXX

【検証3】モデルパラメータの変化: ✅ or ❌
  Actor層0: パラメータ変化量 = X.XXXXXX

エピソード統計:
  平均ステップ数: XXX
  1エピソードでバッファに追加されるデータ数: XXX
```

### ステップ3: 暫定対策（診断結果を待たずに実施可能）

**最も可能性が高い原因: バッファサイズ不足**

config.yamlを以下のように修正:

```yaml
ppo:
  batch_size: 256  # 1024 → 256に変更
  n_episodes: 500  # テスト用に減らす
```

再学習を実行:

```bash
python train_ppo.py --config config.yaml
```

学習ログで以下を確認:

```
エピソードXXX: 
  バッファサイズ=XXX
  → PPO更新を実行  ← これが表示されることを確認
  actor_loss=X.XXXX
```

---

## 🎯 推定される根本原因

### バッファサイズ不足（可能性：高）

**現在の設定**:
- `batch_size: 1024`
- エピソード長: 24時間シミュレーション

**問題の流れ**:

1. エピソード実行 → 環境で教師の行動を実行 → 7.46分
2. データをバッファに蓄積 → バッファサイズが600程度？
3. 更新条件チェック → `len(buffer) < batch_size` → **更新スキップ**
4. パラメータ未更新 → モデルはランダム初期化のまま
5. テスト時 → 未学習エージェント使用 → 20分台

**trainer.pyの該当コード**（L133-135）:

```python
# PPO更新
if len(self.agent.buffer) >= self.agent.batch_size:  # ← 条件を満たさない
    update_stats = self.agent.update()
    self.training_stats.append(update_stats)
```

**対策**:
- `batch_size`を256に下げる（推奨）
- 複数エピソード蓄積してから更新
- エピソード長を長くする

---

## 📊 診断結果の解釈

### パターン1: バッファサイズ不足（予想される結果）

```
最終バッファサイズ: 456/1024  ← 1024未満
❌ 【検証2】PPOの更新実行
   バッファサイズが不足しているため、update()は実行されません
❌ 【検証3】モデルパラメータの変化
   ActorもCriticもパラメータが変化していません！
```

**対策**: batch_sizeを256に下げる

### パターン2: 更新は実行されているが効果なし

```
✅ 【検証2】PPOの更新実行
   actor_loss: 0.XXXX
❌ 【検証3】モデルパラメータの変化
   パラメータ変化量 = 0.000001 (極小)
```

**対策**: 学習率を上げる、勾配計算を確認

### パターン3: すべて正常だが性能が悪い

```
✅ すべての検証に合格しました
```

**しかしテスト性能は悪い**

**原因**: 学習時のログは教師の性能を表示、エージェントは学習中

**対策**: より多くのエピソードで学習、学習曲線を確認

---

## 📝 次のアクション

### 1. 診断実行（今すぐ）

```bash
python debug_training_process.py --config config.yaml --episodes 5
```

### 2. 結果の報告

上記の「結果の報告」セクションのフォーマットで報告

### 3. 対策の実施

診断結果に基づいて適切な対策を実施

### 4. 再学習とテスト

対策後、再学習を実行してテスト性能を確認

---

## 🔧 追加の診断ツール

必要に応じて以下も実行できます：

### テスト時の行動選択診断

```bash
python debug_test_behavior.py \
    --model checkpoints/best_model.pth \
    --config config.yaml \
    --steps 50
```

### 独立したテスト

```bash
python test_trained_model.py \
    --model checkpoints/best_model.pth \
    --config config.yaml \
    --episodes 20
```

---

## 💡 重要なポイント

1. **学習時のログは教師の性能を表示している可能性が高い**
   - 7.46分 = 教師の行動による環境の結果
   - エージェント自体は未学習

2. **最も可能性が高い原因はバッファサイズ不足**
   - update()が実行されていない
   - パラメータが更新されていない

3. **診断スクリプトで原因を確定することが重要**
   - 推測ではなく、実際のデータで判断

4. **暫定対策は診断結果を待たずに実施可能**
   - batch_sizeを256に下げる

---

## 📞 サポート

診断結果を以下のフォーマットで報告してください：

```
【実行コマンド】
python debug_training_process.py --config config.yaml --episodes 5

【診断結果】
✅/❌ バッファへのデータ蓄積
✅/❌ PPOの更新実行
✅/❌ モデルパラメータの変化
✅/❌ モデルの保存・読み込み

【詳細情報】
最終バッファサイズ: XXX/1024
パラメータ変化量: X.XXXXXX
エピソード平均ステップ数: XXX

【その他の情報】
（エラーメッセージ、警告など）
```

**診断結果を待っています！**
