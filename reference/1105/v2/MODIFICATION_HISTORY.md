# 修正履歴: 救急車復帰問題の解決

## 修正1: イベント処理ループの改善 ✅

### 問題
復帰イベントの後ろにNEW_CALLがあると、`break`で即座にループを抜けるため、後続の復帰イベントが処理されない。

### 修正内容
```python
# 復帰イベントを最優先で処理
if event.event_type == EventType.AMBULANCE_AVAILABLE:
    self._process_next_event()
    continue  # ← ループを継続
```

### 効果
- ✅ 復帰イベントが確実に処理される
- ✅ ステップ150で台数増加を確認（118台 → 122台）

---

## 修正2: 復帰時刻の二重計算を修正 ✅

### 問題
`completion_time_seconds`は既に絶対時刻なのに、`dispatch_time`を足して二重計算していた。

### 修正内容
```python
# completion_time_secondsを直接使用
return_time = dispatch_result.get('completion_time_seconds')
```

### 効果
- ✅ 復帰時刻が正確に計算される
- ✅ 救急車が適切なタイミングで復帰

---

## 修正3: `max_steps_per_episode`を時間ベースに修正 ✅

### 問題
```python
# 修正前
self.max_steps_per_episode = len(self.current_episode_calls)  # 1526（事案数）

# しかし実際は:
# - 1ステップ = 1分
# - 24時間 = 1440分 = 1440ステップ
# - つまり、1526ステップは存在しない
```

### 根本原因
「1ステップ=1事案」という旧システムの名残で、`max_steps_per_episode`が事案数（1526）に設定されていた。

しかし、新システムでは「1ステップ=1分」なので、24時間 = 1440ステップが正しい。

### 修正内容
```python
# 修正後
episode_duration_hours = self.config['data'].get('episode_duration_hours', 24)
time_based_max_steps = episode_duration_hours * 60  # 1440分

if config_max_steps:
    self.max_steps_per_episode = config_max_steps
else:
    self.max_steps_per_episode = time_based_max_steps  # 時間ベース
```

### 効果
- ✅ エピソードが正しい時間（24時間=1440分）で終了
- ✅ `_is_episode_done()`の時間制限チェックと整合

---

## 残存する問題（データ起因）

### 問題: ピーク時間帯の救急車不足

```
理論値（Little's Law）:
  必要救急車数 = 1.06 件/分 × 79分 = 83.7台
  実際の救急車数 = 192台
  稼働率 = 43.6%（理論値）

実測値:
  ステップ500以降: 急激に減少（81台 → 73台 → ... → 0台）
  ステップ722: 全車出動
```

### 原因
事案の時間分布が不均一で、ピーク時間帯（昼間）に事案が集中している。

```
平均: 1.06 件/分 = 63.6 件/時間

実際:
- 昼間（8-20時）: 80-100 件/時間（ピーク）← ここで不足
- 夜間（0-8時）:  30-40 件/時間（閑散）
```

### 対策（今後の課題）
1. **ピーク時間帯の分析**
   - 実データの時間分布を詳細に調査
   - どの時間帯に事案が集中しているか特定

2. **救急車数の調整（学習の範囲外）**
   - 現実世界の制約：救急車は増やせない
   - PPOが学習すべきこと：限られた資源を効率的に配分

3. **シミュレーションの精度向上**
   - 休憩時間の導入
   - より精密な活動時間モデル

---

## まとめ

### 修正完了 ✅
1. イベント処理ループ - 復帰イベントを最優先処理
2. 復帰時刻の計算 - 二重計算を修正
3. max_steps_per_episode - 時間ベースに修正

### 期待される効果
- ✅ 復帰イベントが正しく処理される
- ✅ エピソード長が正しい時間で終了
- ⚠️ ピーク時の全車出動は、データの性質上避けられない可能性

### 次のステップ
1. 修正版で学習を実行
2. 全車出動の発生頻度を確認
3. ピーク時間帯の詳細分析

---

**最終更新**: 2025年11月5日  
**修正回数**: 3回  
**ステータス**: コア機能の修正完了、データ起因の問題は残存
