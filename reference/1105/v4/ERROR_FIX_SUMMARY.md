# ã‚¨ãƒ©ãƒ¼ä¿®æ­£ã¨å‹•ä½œç¢ºèªã‚µãƒãƒªãƒ¼

**ä½œæˆæ—¥**: 2025å¹´11æœˆ6æ—¥  
**ä¿®æ­£å†…å®¹**: RewardDesignerã‚¨ãƒ©ãƒ¼ä¿®æ­£ã¨å‹•ä½œç¢ºèª

---

## ğŸ”§ ä¿®æ­£å†…å®¹

### ã‚¨ãƒ©ãƒ¼1: `calculate_unhandled_penalty`ãƒ¡ã‚½ãƒƒãƒ‰ãŒå­˜åœ¨ã—ãªã„

**ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:**
```
AttributeError: 'RewardDesigner' object has no attribute 'calculate_unhandled_penalty'
```

**åŸå› :**
- `_handle_unresponsive_call()`ãƒ¡ã‚½ãƒƒãƒ‰ãŒå­˜åœ¨ã—ãªã„ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—ã¦ã„ãŸ
- `RewardDesigner`ã‚¯ãƒ©ã‚¹ã«ã¯`get_failure_penalty()`ãƒ¡ã‚½ãƒƒãƒ‰ã®ã¿å­˜åœ¨

**ä¿®æ­£å†…å®¹:**
```python
# ä¿®æ­£å‰
penalty = self.reward_designer.calculate_unhandled_penalty(call['severity'], wait_time, response_type)

# ä¿®æ­£å¾Œ
base_penalty = self.reward_designer.get_failure_penalty('unhandled')

# å‚·ç—…åº¦ã¨å¾…æ©Ÿæ™‚é–“ã«å¿œã˜ãŸå‹•çš„ãƒšãƒŠãƒ«ãƒ†ã‚£è¨ˆç®—
severity_multiplier = {
    'é‡ç¯¤': 3.0,
    'é‡ç—‡': 2.5,
    'ä¸­ç­‰ç—‡': 1.5,
    'è»½ç—‡': 1.0
}.get(severity, 1.0)

wait_time_penalty = wait_time * 0.5
penalty = base_penalty * severity_multiplier - wait_time_penalty
```

**åŠ¹æœ:**
- âœ… ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãªããªã‚‹
- âœ… å‚·ç—…åº¦ã¨å¾…æ©Ÿæ™‚é–“ã«å¿œã˜ãŸé©åˆ‡ãªãƒšãƒŠãƒ«ãƒ†ã‚£è¨ˆç®—
- âœ… ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ãŒæ­£å¸¸ã«ç¶™ç¶šã§ãã‚‹

---

## âœ… å¾©å¸°å‡¦ç†ã®ç¢ºèª

### å®Ÿè£…ç¢ºèª

**å¾©å¸°ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†:**
```python
def _handle_ambulance_return_event(self, event: Event):
    amb_id = event.data['ambulance_id']
    station_h3 = event.data['station_h3']
    
    if amb_id in self.ambulance_states:
        self.ambulance_states[amb_id]['status'] = 'available'
        self.ambulance_states[amb_id]['current_h3'] = station_h3
        self.ambulance_states[amb_id]['completion_time'] = 0.0  # é‡è¦
```

**ç¢ºèªãƒã‚¤ãƒ³ãƒˆ:**
- âœ… `status`ãŒ`'available'`ã«è¨­å®šã•ã‚Œã‚‹
- âœ… `current_h3`ãŒé§…ã«è¨­å®šã•ã‚Œã‚‹
- âœ… `completion_time`ãŒã‚¯ãƒªã‚¢ã•ã‚Œã‚‹ï¼ˆæ¬¡å›é…è»Šå¯èƒ½ï¼‰

**ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ãƒ«ãƒ¼ãƒ—:**
```python
if event.event_type == EventType.AMBULANCE_AVAILABLE:
    self._process_next_event()
    events_processed += 1
    continue  # å¸¸ã«å‡¦ç†ã•ã‚Œã‚‹
```

**ç¢ºèªãƒã‚¤ãƒ³ãƒˆ:**
- âœ… å¾©å¸°ã‚¤ãƒ™ãƒ³ãƒˆã¯å¸¸ã«å‡¦ç†ã•ã‚Œã‚‹ï¼ˆ`pending_call`ã®çŠ¶æ…‹ã«é–¢ä¿‚ãªãï¼‰
- âœ… ã‚¤ãƒ™ãƒ³ãƒˆã‚­ãƒ¥ãƒ¼ã‹ã‚‰æ­£ã—ãpopã•ã‚Œã‚‹
- âœ… æ™‚é–“ãŒé€²ã‚€éš›ã«æ­£ã—ãå‡¦ç†ã•ã‚Œã‚‹

---

## ğŸ“Š ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ã®å‹•ä½œç¢ºèª

### ãƒ­ã‚°ã‹ã‚‰ç¢ºèªã•ã‚ŒãŸå‹•ä½œ

**ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰3ã®ãƒ­ã‚°:**
```
[é…è»Š] Ep3-710: è»½ç—‡ â†’ æ±å“å·æ•‘æ€¥(å®Ÿè»Š) 30.1åˆ† (åˆ©ç”¨å¯èƒ½:8å°)
âš¡ ä¸­ç­‰ç—‡å¿œæ´: ä¸­ç­‰ç—‡ (67.0åˆ†å¾…æ©Ÿ) â†’ ä»–åœ°åŸŸéšŠãŒ92.0åˆ†ã§å¯¾å¿œ
âŒ step()ãƒ¡ã‚½ãƒƒãƒ‰ã§ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ: 'RewardDesigner' object has no attribute 'calculate_unhandled_penalty'
```

**åˆ†æ:**
1. âœ… ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†è‡ªä½“ã¯å‹•ä½œã—ã¦ã„ã‚‹ï¼ˆãƒ­ã‚°å‡ºåŠ›ã‚ã‚Šï¼‰
2. âŒ ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿã«ã‚ˆã‚Šã€ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ãŒå¼·åˆ¶çµ‚äº†ï¼ˆ715ã‚¹ãƒ†ãƒƒãƒ—ï¼‰
3. âŒ ã‚¨ãƒ©ãƒ¼å¾Œã€`total_calls`ãŒ498ä»¶ã®ã¾ã¾ï¼ˆæ”¹å–„ãªã—ï¼‰

**ä¿®æ­£å¾Œã®æœŸå¾…å‹•ä½œ:**
1. âœ… ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ãŒæ­£å¸¸ã«å‹•ä½œ
2. âœ… ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãªã„
3. âœ… ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ãŒ1440ã‚¹ãƒ†ãƒƒãƒ—ã¾ã§ç¶™ç¶š
4. âœ… `total_calls`ãŒ1500ä»¶ä»¥ä¸Šã«æ”¹å–„

---

## ğŸ” ãã®ä»–ã®ç¢ºèªäº‹é …

### 1. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

**ç¾åœ¨ã®å®Ÿè£…:**
```python
except Exception as e:
    print(f"âŒ step()ãƒ¡ã‚½ãƒƒãƒ‰ã§ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ: {e}")
    traceback.print_exc()
    return StepResult(
        observation=np.zeros(self.state_dim),
        reward=0.0,
        done=True,  # â† ã‚¨ãƒ©ãƒ¼æ™‚ã«å¼·åˆ¶çµ‚äº†
        info={'error': str(e)}
    )
```

**å•é¡Œç‚¹:**
- ã‚¨ãƒ©ãƒ¼æ™‚ã«`done=True`ã‚’è¿”ã™ãŸã‚ã€ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ãŒå¼·åˆ¶çµ‚äº†
- ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã€å­¦ç¿’ãŒç¶™ç¶šã§ããªã„

**ä»Šå¾Œã®æ”¹å–„æ¡ˆ:**
- ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ã€å¯èƒ½ãªé™ã‚Šã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã‚’ç¶™ç¶š
- ã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’`info`ã«è¨˜éŒ²ã—ã€å­¦ç¿’ãƒ«ãƒ¼ãƒ—ã§å‡¦ç†

### 2. ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ã®ãƒ­ã‚°

**ç¾åœ¨ã®å®Ÿè£…:**
```python
if self.episode_step <= 50:  # æœ€åˆã®50ã‚¹ãƒ†ãƒƒãƒ—ã®ã¿ãƒ­ã‚°
    print(f"[TIMEOUT] äº‹æ¡ˆ{self.pending_call['id']}ã‚’{self.pending_call['severity']}ã¨ã—ã¦ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ï¼ˆ{wait_time_seconds/60:.1f}åˆ†å¾…æ©Ÿï¼‰")
```

**ç¢ºèªãƒã‚¤ãƒ³ãƒˆ:**
- âœ… ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç™ºç”Ÿæ™‚ã«ãƒ­ã‚°å‡ºåŠ›ï¼ˆæœ€åˆã®50ã‚¹ãƒ†ãƒƒãƒ—ï¼‰
- âœ… `_handle_unresponsive_call()`å†…ã§ã‚‚ãƒ­ã‚°å‡ºåŠ›ï¼ˆå‚·ç—…åº¦åˆ¥ï¼‰

**æ”¹å–„æ¡ˆ:**
- ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç™ºç”Ÿå›æ•°ã‚’çµ±è¨ˆã«è¨˜éŒ²
- wandbã«è¨˜éŒ²ã—ã¦ç›£è¦–

---

## ğŸ“ˆ æœŸå¾…ã•ã‚Œã‚‹æ”¹å–„

### ä¿®æ­£å‰ï¼ˆã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ï¼‰
```
episode_length: 715ï¼ˆã‚¨ãƒ©ãƒ¼ã§å¼·åˆ¶çµ‚äº†ï¼‰
total_calls: 498ä»¶ï¼ˆ33%ï¼‰
ã‚¨ãƒ©ãƒ¼: calculate_unhandled_penaltyãŒå­˜åœ¨ã—ãªã„
```

### ä¿®æ­£å¾Œï¼ˆæœŸå¾…å€¤ï¼‰
```
episode_length: 1440ï¼ˆæ­£å¸¸çµ‚äº†ï¼‰
total_calls: 1500ä»¶ä»¥ä¸Šï¼ˆ98%ä»¥ä¸Šï¼‰
ã‚¨ãƒ©ãƒ¼: ãªã—
ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: é©åˆ‡ã«å‡¦ç†ã•ã‚Œã‚‹
```

---

## ğŸ¯ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. **ä¿®æ­£ã®é©ç”¨ç¢ºèª**
   - âœ… `calculate_unhandled_penalty`ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£
   - âœ… å‚·ç—…åº¦ã¨å¾…æ©Ÿæ™‚é–“ã«å¿œã˜ãŸãƒšãƒŠãƒ«ãƒ†ã‚£è¨ˆç®—ã‚’å®Ÿè£…

2. **å‹•ä½œç¢ºèª**
   - å­¦ç¿’ã‚’å†å®Ÿè¡Œã—ã¦ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãªã„ã‹ç¢ºèª
   - `total_calls`ãŒæ”¹å–„ã™ã‚‹ã‹ç¢ºèª
   - ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã‹ç¢ºèª

3. **çµ±è¨ˆã®ç¢ºèª**
   - ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç™ºç”Ÿå›æ•°ã‚’ç¢ºèª
   - å‚·ç—…åº¦åˆ¥ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç‡ã‚’ç¢ºèª
   - å¾©å¸°ã‚¤ãƒ™ãƒ³ãƒˆãŒæ­£ã—ãå‡¦ç†ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

---

## ğŸ“ ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«

- `reinforcement_learning/environment/ems_environment.py`
  - `_handle_unresponsive_call()`ãƒ¡ã‚½ãƒƒãƒ‰ã®ãƒšãƒŠãƒ«ãƒ†ã‚£è¨ˆç®—éƒ¨åˆ†ã‚’ä¿®æ­£

---

**çµè«–**: 
ã‚¨ãƒ©ãƒ¼ã¯ä¿®æ­£ã•ã‚Œã¾ã—ãŸã€‚æ¬¡å›ã®å­¦ç¿’å®Ÿè¡Œã§ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã›ãšã€ã™ã¹ã¦ã®äº‹æ¡ˆãŒå‡¦ç†ã•ã‚Œã‚‹ã“ã¨ã‚’æœŸå¾…ã—ã¾ã™ã€‚

