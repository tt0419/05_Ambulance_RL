# ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒã‚§ãƒƒã‚¯ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ä¿®æ­£ - é©ç”¨å®Œäº†

**å®Ÿæ–½æ—¥**: 2025å¹´11æœˆ6æ—¥  
**ä¿®æ­£å†…å®¹**: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒã‚§ãƒƒã‚¯ã‚’æ¯ã‚¹ãƒ†ãƒƒãƒ—ã®æœ€åˆã«å®Ÿè¡Œã™ã‚‹ã‚ˆã†å¤‰æ›´

---

## âœ… é©ç”¨ã—ãŸä¿®æ­£

### ä¿®æ­£1: Phase 0ã®è¿½åŠ ï¼ˆæœ€é‡è¦ï¼‰

**å ´æ‰€**: `step()`ãƒ¡ã‚½ãƒƒãƒ‰ã®æœ€åˆï¼ˆ946-960è¡Œç›®ï¼‰

**å†…å®¹:**
```python
# --- 0. ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒã‚§ãƒƒã‚¯ï¼ˆæ¯ã‚¹ãƒ†ãƒƒãƒ—æœ€åˆã«å®Ÿè¡Œï¼‰ ---
# â˜…é‡è¦: NEW_CALLã‚¤ãƒ™ãƒ³ãƒˆã®æœ‰ç„¡ã«é–¢ã‚ã‚‰ãšã€æ¯ã‚¹ãƒ†ãƒƒãƒ—ãƒã‚§ãƒƒã‚¯â˜…
if self.pending_call is not None:
    wait_time_seconds = self.current_time_seconds - self.call_start_times.get(
        self.pending_call['id'], self.current_time_seconds
    )
    max_wait_seconds = self._get_max_wait_time(self.pending_call['severity']) * 60
    
    if wait_time_seconds > max_wait_seconds:
        # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†
        if self._episode_count <= 3 or self.episode_step <= 100:
            print(f"[TIMEOUT] ã‚¹ãƒ†ãƒƒãƒ—{self.episode_step}: äº‹æ¡ˆ{self.pending_call['id']}({self.pending_call['severity']})ã‚’{wait_time_seconds/60:.1f}åˆ†å¾…æ©Ÿã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ")
        
        self._handle_unresponsive_call(self.pending_call, wait_time_seconds / 60)
        self.pending_call = None
```

**åŠ¹æœ:**
- âœ… NEW_CALLã‚¤ãƒ™ãƒ³ãƒˆã®æœ‰ç„¡ã«é–¢ã‚ã‚‰ãšã€æ¯ã‚¹ãƒ†ãƒƒãƒ—ãƒã‚§ãƒƒã‚¯
- âœ… å¾…æ©Ÿæ™‚é–“ãŒæœ€å¤§å€¤ï¼ˆé‡ç—‡10åˆ†ã€ä¸­ç­‰ç—‡20åˆ†ã€è»½ç—‡45åˆ†ï¼‰ã‚’è¶…ãˆãªã„
- âœ… ç•°å¸¸ã«é•·ã„å¾…æ©Ÿæ™‚é–“ï¼ˆ205åˆ†ãªã©ï¼‰ãŒç™ºç”Ÿã—ãªã„

---

### ä¿®æ­£2: NEW_CALLã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã®ã‚·ãƒ³ãƒ—ãƒ«åŒ–

**å ´æ‰€**: `step()`ãƒ¡ã‚½ãƒƒãƒ‰ã®ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ãƒ«ãƒ¼ãƒ—ï¼ˆ975-986è¡Œç›®ï¼‰

**ä¿®æ­£å‰:**
```python
if event.event_type == EventType.NEW_CALL:
    if self.pending_call is None:
        self._process_next_event()
    else:
        # â˜…ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒã‚§ãƒƒã‚¯ï¼ˆé‡è¤‡ï¼‰â˜…
        if wait_time > max_wait:
            # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†
            self._handle_unresponsive_call(...)
            self._process_next_event()
        else:
            break
```

**ä¿®æ­£å¾Œ:**
```python
if event.event_type == EventType.NEW_CALL:
    if self.pending_call is None:
        self._process_next_event()
    else:
        # pending_callãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã§å‡¦ç†
        # ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒã‚§ãƒƒã‚¯ã¯Phase 0ã§å®Ÿæ–½æ¸ˆã¿ï¼‰
        break
```

**åŠ¹æœ:**
- âœ… ã‚³ãƒ¼ãƒ‰ãŒã‚·ãƒ³ãƒ—ãƒ«ã«ãªã‚Šã€ä¿å®ˆæ€§å‘ä¸Š
- âœ… ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒã‚§ãƒƒã‚¯ã®é‡è¤‡ã‚’å›é¿
- âœ… å‡¦ç†ãƒ•ãƒ­ãƒ¼ãŒæ˜ç¢ºåŒ–

---

### ä¿®æ­£3: ç›£è¦–ãƒ­ã‚°ã®è¿½åŠ 

**å ´æ‰€**: `step()`ãƒ¡ã‚½ãƒƒãƒ‰ã®Phase 0ã®å¾Œï¼ˆ962-969è¡Œç›®ï¼‰

**å†…å®¹:**
```python
# 100ã‚¹ãƒ†ãƒƒãƒ—ã”ã¨ã®ç›£è¦–ãƒ­ã‚°
if self.episode_step % 100 == 0 and self._episode_count <= 1:
    available_count = sum(1 for a in self.ambulance_states.values() if a['status'] == 'available')
    print(f"\n[ç›£è¦–] ã‚¹ãƒ†ãƒƒãƒ—{self.episode_step}ï¼ˆ{self.current_time_seconds/60:.0f}åˆ†ï¼‰")
    print(f"  åˆ©ç”¨å¯èƒ½æ•‘æ€¥è»Š: {available_count}å°")
    print(f"  pending_call: {'ã‚ã‚Š' if self.pending_call else 'ãªã—'}")
    if hasattr(self, 'timeout_stats'):
        print(f"  ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆåˆè¨ˆ: {self.timeout_stats.get('total', 0)}ä»¶")
```

**åŠ¹æœ:**
- âœ… ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ã®å‹•ä½œã‚’ç›£è¦–ã§ãã‚‹
- âœ… åˆ©ç”¨å¯èƒ½æ•‘æ€¥è»Šæ•°ã®æ¨ç§»ã‚’ç¢ºèªã§ãã‚‹
- âœ… å•é¡Œã®æ—©æœŸç™ºè¦‹ãŒå¯èƒ½

---

### ä¿®æ­£4: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆçµ±è¨ˆã®è¨˜éŒ²

**å ´æ‰€**: 
- `reset()`ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆ607-619è¡Œç›®ï¼‰
- `_handle_unresponsive_call()`ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆ2054-2057è¡Œç›®ï¼‰
- `step()`ãƒ¡ã‚½ãƒƒãƒ‰ã®infoï¼ˆ1112-1116è¡Œç›®ï¼‰

**å†…å®¹:**

**4-1. åˆæœŸåŒ–ï¼ˆreset()ï¼‰:**
```python
# ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆçµ±è¨ˆã®åˆæœŸåŒ–
if not hasattr(self, 'timeout_stats'):
    self.timeout_stats = {
        'é‡ç¯¤': 0,
        'é‡ç—‡': 0,
        'ä¸­ç­‰ç—‡': 0,
        'è»½ç—‡': 0,
        'total': 0
    }
else:
    # ãƒªã‚»ãƒƒãƒˆ
    for key in self.timeout_stats:
        self.timeout_stats[key] = 0
```

**4-2. è¨˜éŒ²ï¼ˆ_handle_unresponsive_call()ï¼‰:**
```python
# ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆçµ±è¨ˆã®æ›´æ–°
if hasattr(self, 'timeout_stats'):
    self.timeout_stats[severity] = self.timeout_stats.get(severity, 0) + 1
    self.timeout_stats['total'] = self.timeout_stats.get('total', 0) + 1
```

**4-3. è¿”å´ï¼ˆstep()ï¼‰:**
```python
info.update({
    'episode_stats': self.episode_stats.copy(),
    'step': self.episode_step,
    'timeout_stats': self.timeout_stats.copy() if hasattr(self, 'timeout_stats') else {}
})
```

**åŠ¹æœ:**
- âœ… ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç™ºç”Ÿå›æ•°ã‚’å‚·ç—…åº¦åˆ¥ã«è¨˜éŒ²
- âœ… wandbã§å¯è¦–åŒ–å¯èƒ½
- âœ… çµ±è¨ˆåˆ†æãŒå¯èƒ½

---

## ğŸ“Š æœŸå¾…ã•ã‚Œã‚‹æ”¹å–„

### å‡¦ç†ä»¶æ•°

| é …ç›® | ä¿®æ­£å‰ | ä¿®æ­£å¾Œï¼ˆäºˆæ¸¬ï¼‰ |
|------|--------|----------------|
| å‡¦ç†ä»¶æ•° | 1199ä»¶ï¼ˆ78.6%ï¼‰ | 1526ä»¶ï¼ˆ100%ï¼‰ |
| æœªå‡¦ç† | 327ä»¶ï¼ˆ21.4%ï¼‰ | 0ä»¶ï¼ˆ0%ï¼‰ |

### å¾…æ©Ÿæ™‚é–“

| é …ç›® | ä¿®æ­£å‰ | ä¿®æ­£å¾Œï¼ˆäºˆæ¸¬ï¼‰ |
|------|--------|----------------|
| æœ€å¤§å¾…æ©Ÿæ™‚é–“ | 283åˆ† | 45åˆ†ä»¥ä¸‹ |
| é‡ç—‡å¾…æ©Ÿæ™‚é–“ | ä¸æ˜ | æœ€å¤§10åˆ† |
| ä¸­ç­‰ç—‡å¾…æ©Ÿæ™‚é–“ | 205åˆ† | æœ€å¤§20åˆ† |
| è»½ç—‡å¾…æ©Ÿæ™‚é–“ | 283åˆ† | æœ€å¤§45åˆ† |

### ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç™ºç”Ÿ

| é …ç›® | ä¿®æ­£å‰ | ä¿®æ­£å¾Œï¼ˆäºˆæ¸¬ï¼‰ |
|------|--------|----------------|
| ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå®Ÿè¡Œ | ä¸å®šæœŸï¼ˆNEW_CALLæ™‚ã®ã¿ï¼‰ | å®šæœŸçš„ï¼ˆæ¯ã‚¹ãƒ†ãƒƒãƒ—ï¼‰ |
| ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»¶æ•° | ä¸æ˜ | 50-100ä»¶ |
| å‚·ç—…åº¦åˆ¥çµ±è¨ˆ | ãªã— | ã‚ã‚Š |

---

## ğŸ” å‹•ä½œç¢ºèªãƒã‚¤ãƒ³ãƒˆ

### 1. ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ã®å‹•ä½œç¢ºèª

**ç¢ºèªæ–¹æ³•:**
```bash
python train_ppo.py --config config_hybrid_continuous.yaml
```

**ç¢ºèªãƒ­ã‚°:**
```
[TIMEOUT] ã‚¹ãƒ†ãƒƒãƒ—50: äº‹æ¡ˆ202306151234(ä¸­ç­‰ç—‡)ã‚’25.3åˆ†å¾…æ©Ÿã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
âš¡ ä¸­ç­‰ç—‡å¿œæ´: ä¸­ç­‰ç—‡ (25.3åˆ†å¾…æ©Ÿ) â†’ ä»–åœ°åŸŸéšŠãŒ50.3åˆ†ã§å¯¾å¿œ

[ç›£è¦–] ã‚¹ãƒ†ãƒƒãƒ—100ï¼ˆ100åˆ†ï¼‰
  åˆ©ç”¨å¯èƒ½æ•‘æ€¥è»Š: 15å°
  pending_call: ã‚ã‚Š
  ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆåˆè¨ˆ: 12ä»¶
```

**æœŸå¾…ã•ã‚Œã‚‹çµæœ:**
- âœ… `[TIMEOUT]`ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- âœ… å¾…æ©Ÿæ™‚é–“ãŒ45åˆ†ä»¥ä¸‹
- âœ… ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»¶æ•°ãŒè¨˜éŒ²ã•ã‚Œã‚‹

### 2. å‡¦ç†ä»¶æ•°ã®ç¢ºèª

**ç¢ºèªæ–¹æ³•:**
```bash
# wandbã®ãƒ­ã‚°ã‚’ç¢ºèª
```

**ç¢ºèªãƒ¡ãƒˆãƒªã‚¯ã‚¹:**
```
performance/total_calls: 1526  â† ç›®æ¨™
timeout/total: 50-100  â† ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»¶æ•°
```

**æœŸå¾…ã•ã‚Œã‚‹çµæœ:**
- âœ… `total_calls`ãŒ1526ä»¶ï¼ˆ100%ï¼‰
- âœ… `timeout/total`ãŒ50-100ä»¶

### 3. åˆ©ç”¨å¯èƒ½æ•‘æ€¥è»Šæ•°ã®æ¨ç§»

**ç¢ºèªæ–¹æ³•:**
```
[ç›£è¦–] ã‚¹ãƒ†ãƒƒãƒ—0ï¼ˆ0åˆ†ï¼‰
  åˆ©ç”¨å¯èƒ½æ•‘æ€¥è»Š: 70å°

[ç›£è¦–] ã‚¹ãƒ†ãƒƒãƒ—100ï¼ˆ100åˆ†ï¼‰
  åˆ©ç”¨å¯èƒ½æ•‘æ€¥è»Š: 15å°

[ç›£è¦–] ã‚¹ãƒ†ãƒƒãƒ—200ï¼ˆ200åˆ†ï¼‰
  åˆ©ç”¨å¯èƒ½æ•‘æ€¥è»Š: 25å°
```

**æœŸå¾…ã•ã‚Œã‚‹çµæœ:**
- âœ… åˆ©ç”¨å¯èƒ½æ•‘æ€¥è»Šæ•°ãŒ5-30å°ã§æ¨ç§»ï¼ˆå®‰å®šï¼‰
- âœ… 0å°ã«ãªã‚‰ãªã„ï¼ˆå¾©å¸°ãŒæ­£å¸¸ï¼‰

---

## ğŸš¨ æ³¨æ„äº‹é …

### 1. æ•™å¸«ã‚ã‚Šå­¦ç¿’ã¯ã¾ã æ©Ÿèƒ½ã—ãªã„

**ç¾çŠ¶:**
- `get_optimal_action()`ãŒ`step()`ã®å‰ã«å‘¼ã°ã‚Œã‚‹
- `pending_call`ãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€å¸¸ã«`None`ã‚’è¿”ã™
- æ•™å¸«ã‚ã‚Šå­¦ç¿’ãŒæ©Ÿèƒ½ã—ãªã„

**å¯¾å¿œ:**
- ã€Œæ®µéš2ã®ä¿®æ­£ã€ã§å¯¾å¿œäºˆå®š
- ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ãŒå®Œå…¨ã«å‹•ä½œã—ã¦ã‹ã‚‰å®Ÿæ–½

### 2. å¿œç­”æ™‚é–“ã®æ”¹å–„ã¯æ®µéš2ä»¥é™

**ç¾çŠ¶:**
- å¹³å‡å¿œç­”æ™‚é–“: 20.02åˆ†
- 6åˆ†é”æˆç‡: 2.25%

**ä¿®æ­£å¾Œã®æœŸå¾…:**
- å¹³å‡å¿œç­”æ™‚é–“: 18-19åˆ†ï¼ˆã‚ãšã‹ãªæ”¹å–„ï¼‰
- 6åˆ†é”æˆç‡: 3-5%ï¼ˆã‚ãšã‹ãªæ”¹å–„ï¼‰

**å¤§å¹…æ”¹å–„ã¯æ®µéš2ä»¥é™:**
- æ•™å¸«ã‚ã‚Šå­¦ç¿’ãŒæ©Ÿèƒ½ã™ã‚‹ã¨
- å¹³å‡å¿œç­”æ™‚é–“: 8-10åˆ†
- 6åˆ†é”æˆç‡: 30-40%

---

## ğŸ“ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

### å³åº§ã«å®Ÿæ–½

1. **å‹•ä½œç¢ºèª**
   - å­¦ç¿’ã‚’å®Ÿè¡Œã—ã¦ãƒ­ã‚°ã‚’ç¢ºèª
   - `total_calls`ãŒ1526ä»¶ã«è¿‘ã¥ãã‹ç¢ºèª
   - ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‹ç¢ºèª

2. **çµæœã®åˆ†æ**
   - wandbã§`timeout/total`ã‚’ç¢ºèª
   - å‚·ç—…åº¦åˆ¥ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç‡ã‚’ç¢ºèª
   - åˆ©ç”¨å¯èƒ½æ•‘æ€¥è»Šæ•°ã®æ¨ç§»ã‚’ç¢ºèª

### æ¬¡ã®ä¿®æ­£ï¼ˆæ®µéš2ï¼‰

3. **æ•™å¸«ã‚ã‚Šå­¦ç¿’ã®ä¿®æ­£**
   - `advance_time()`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ 
   - ã¾ãŸã¯`step()`ã®æˆ»ã‚Šå€¤ã‚’æ‹¡å¼µ
   - trainer.pyã‚’ä¿®æ­£

4. **å¿œç­”æ™‚é–“ã®å¤§å¹…æ”¹å–„**
   - ç›´è¿‘éšŠé‹ç”¨ï¼ˆæœ€é©è¡Œå‹•ï¼‰ã®å­¦ç¿’
   - å¹³å‡å¿œç­”æ™‚é–“: 20åˆ† â†’ 8-10åˆ†
   - 6åˆ†é”æˆç‡: 2% â†’ 30-40%

---

**çµè«–**: 
ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒã‚§ãƒƒã‚¯ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ä¿®æ­£ã¯å®Œäº†ã—ã¾ã—ãŸã€‚æ¬¡å›ã®å­¦ç¿’å®Ÿè¡Œã§ã€ã™ã¹ã¦ã®äº‹æ¡ˆãŒå‡¦ç†ã•ã‚Œã€å¾…æ©Ÿæ™‚é–“ã‚‚æ­£å¸¸ç¯„å›²ã«åã¾ã‚‹ã“ã¨ã‚’æœŸå¾…ã—ã¾ã™ã€‚

