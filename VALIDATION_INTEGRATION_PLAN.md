# ValidationSimulatorå®Œå…¨çµ±åˆè¨ˆç”»æ›¸

## ğŸ“‹ ç›®çš„

ç¾åœ¨ã®PPOå­¦ç¿’ç’°å¢ƒ(`ems_environment.py`)ã¨ValidationSimulatorã®ç’°å¢ƒå·®ã‚’è§£æ¶ˆã—ã€å­¦ç¿’ç²¾åº¦ã¨æ¤œè¨¼ç²¾åº¦ã‚’ä¸€è‡´ã•ã›ã‚‹ã€‚

## ğŸ¯ é”æˆç›®æ¨™

### å®šé‡çš„ç›®æ¨™
| æŒ‡æ¨™ | ç¾çŠ¶ | ç›®æ¨™ |
|------|------|------|
| å¹³å‡å¿œç­”æ™‚é–“ | 21.67åˆ† | 8.0åˆ†ä»¥ä¸‹ |
| 6åˆ†é”æˆç‡ | 2.8% | 40%ä»¥ä¸Š |
| å…¨è»Šå‡ºå‹•ä¸­é »åº¦ | 50-72å›/ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ | 10å›ä»¥ä¸‹/ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ |
| ValidationSimulatorã¨ã®æ€§èƒ½å·® | PPO -48%æ‚ªåŒ– | Â±5%ä»¥å†… |

### å®šæ€§çš„ç›®æ¨™
- ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•å‹ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚ˆã‚‹æ­£ç¢ºãªæ™‚é–“ç®¡ç†
- ãƒ•ã‚§ãƒ¼ã‚ºåˆ¥ç§»å‹•æ™‚é–“è¡Œåˆ—ã®å®Œå…¨ã‚µãƒãƒ¼ãƒˆ
- ServiceTimeGeneratorã®çµ±åˆã«ã‚ˆã‚‹ç¢ºç‡çš„æ´»å‹•æ™‚é–“ç”Ÿæˆ
- ValidationSimulatorã¨ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£çµ±ä¸€

---

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

### ç¾çŠ¶ã®å•é¡Œï¼ˆ3å±¤æ§‹é€ ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒ¬ã‚¤ãƒ¤ãƒ¼1: æ™‚é–“ç®¡ç†ã®ä¸æ•´åˆ                           â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ å•é¡Œ: äº‹æ¡ˆé–“ã®æ™‚é–“ã‚¸ãƒ£ãƒ³ãƒ—ã«ã‚ˆã‚Šæ•‘æ€¥è»Šå¾©å¸°ãŒé…å»¶      â”‚
â”‚ å½±éŸ¿: å…¨è»Šå‡ºå‹•ä¸­ãŒé »ç™ºï¼ˆ50-72å›/ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ï¼‰         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒ¬ã‚¤ãƒ¤ãƒ¼2: ç§»å‹•æ™‚é–“è¨ˆç®—ã®ç°¡ç•¥åŒ–                       â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ å•é¡Œ: å˜ä¸€ã®'response'è¡Œåˆ—ã®ã¿ä½¿ç”¨                   â”‚
â”‚ æ­£è§£: response/transport/returnã§ç•°ãªã‚‹è¡Œåˆ—          â”‚
â”‚ å½±éŸ¿: ç§»å‹•æ™‚é–“ã®æ¨å®šèª¤å·®ãŒç´¯ç©                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒ¬ã‚¤ãƒ¤ãƒ¼3: ã‚µãƒ¼ãƒ“ã‚¹æ™‚é–“ã®å›ºå®šå€¤ä½¿ç”¨                   â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ å•é¡Œ: ç°¡æ˜“çš„ãªå›ºå®šå€¤ï¼ˆ15åˆ†ã€20åˆ†ãªã©ï¼‰               â”‚
â”‚ æ­£è§£: å‚·ç—…åº¦ãƒ»æ™‚é–“å¸¯ãƒ»åœ°åŸŸã‚’è€ƒæ…®ã—ãŸç¢ºç‡çš„ç”Ÿæˆ       â”‚
â”‚ å½±éŸ¿: æ´»å‹•æ™‚é–“ã®ä¸æ­£ç¢ºã•                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ–°ã—ã„ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           PPOå­¦ç¿’ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å±¤                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  - step(action) â†’ (obs, reward, done, info)        â”‚
â”‚  - reset() â†’ obs                                    â”‚
â”‚  - get_action_mask() â†’ bool[192]                    â”‚
â”‚  - Gymäº’æ›API                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“ æ™‚é–“ã®æŠ½è±¡åŒ–
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ã‚¢                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  - å„ªå…ˆåº¦ä»˜ãã‚­ãƒ¥ãƒ¼ï¼ˆheapqï¼‰                         â”‚
â”‚  - é€£ç¶šæ™‚é–“ç®¡ç†ï¼ˆfloatç§’ï¼‰                           â”‚
â”‚  - ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ãƒ«ãƒ¼ãƒ—                               â”‚
â”‚    â€¢ NEW_CALL: äº‹æ¡ˆç™ºç”Ÿ                             â”‚
â”‚    â€¢ AMBULANCE_RETURN: æ•‘æ€¥è»Šå¾©å¸°                   â”‚
â”‚    â€¢ CHECKPOINT: å­¦ç¿’ç”¨ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“ ValidationSimulatoräº’æ›
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        ValidationSimulatoräº’æ›ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  - ãƒ•ã‚§ãƒ¼ã‚ºåˆ¥ç§»å‹•æ™‚é–“è¡Œåˆ—                            â”‚
â”‚    â€¢ response: å‡ºå ´æ™‚                               â”‚
â”‚    â€¢ transport: æ¬é€æ™‚                              â”‚
â”‚    â€¢ return: å¸°ç½²æ™‚                                 â”‚
â”‚  - ServiceTimeGeneratorEnhanced                     â”‚
â”‚    â€¢ å‚·ç—…åº¦åˆ¥ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿                             â”‚
â”‚    â€¢ æ™‚é–“å¸¯ãƒ»åœ°åŸŸè€ƒæ…®                               â”‚
â”‚  - ç¢ºç‡çš„ç—…é™¢é¸æŠãƒ¢ãƒ‡ãƒ«                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ å®Ÿè£…è¨ˆç”»ï¼ˆ5æ®µéšï¼‰

### Phase 1: ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ã‚³ã‚¢ã®å®Ÿè£… â­ æœ€å„ªå…ˆ

**ç›®çš„**: ValidationSimulatorã¨åŒã˜æ™‚é–“ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã®å°å…¥

**å®Ÿè£…å†…å®¹**:
```python
# 1. ã‚¤ãƒ™ãƒ³ãƒˆã‚¯ãƒ©ã‚¹ã®å®šç¾©
@dataclass
class Event:
    time: float              # ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿæ™‚åˆ»ï¼ˆç§’ï¼‰
    event_type: EventType    # NEW_CALL, AMBULANCE_RETURN, etc.
    data: Dict[str, Any]    # ã‚¤ãƒ™ãƒ³ãƒˆå›ºæœ‰ãƒ‡ãƒ¼ã‚¿

# 2. ã‚¤ãƒ™ãƒ³ãƒˆã‚­ãƒ¥ãƒ¼ã®ç®¡ç†
self.event_queue = []  # heapq
self.current_time = 0.0  # é€£ç¶šæ™‚é–“

# 3. ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ãƒ«ãƒ¼ãƒ—
def _process_next_event(self):
    event = heapq.heappop(self.event_queue)
    self.current_time = event.time  # æ™‚é–“ã‚’é€²ã‚ã‚‹
    
    if event.event_type == EventType.AMBULANCE_RETURN:
        # æ•‘æ€¥è»Šã‚’å¾©å¸°ã•ã›ã‚‹
        self.ambulance_states[event.data['ambulance_id']]['status'] = 'available'
```

**æœŸå¾…åŠ¹æœ**:
- âœ… å…¨è»Šå‡ºå‹•ä¸­å•é¡Œã®è§£æ¶ˆï¼ˆ50-72å› â†’ 10å›ä»¥ä¸‹ï¼‰
- âœ… æ•‘æ€¥è»Šã®æ­£ç¢ºãªå¾©å¸°ã‚¿ã‚¤ãƒŸãƒ³ã‚°
- âœ… äº‹æ¡ˆé–“ã§ã®çŠ¶æ…‹æ›´æ–°ã®ä¿è¨¼

**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**:
- `reinforcement_learning/environment/ems_environment.py` (å…¨é¢æ”¹ä¿®)

**æ¤œè¨¼æ–¹æ³•**:
```python
# ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
env = EMSEnvironment(...)
obs = env.reset()

# å…¨è»Šå‡ºå‹•ä¸­ã®ç™ºç”Ÿå›æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
all_busy_count = 0
for step in range(1000):
    mask = env.get_action_mask()
    if not mask.any():
        all_busy_count += 1
    # ...

print(f"å…¨è»Šå‡ºå‹•ä¸­: {all_busy_count}å›")  # ç›®æ¨™: 10å›ä»¥ä¸‹
```

---

### Phase 2: ãƒ•ã‚§ãƒ¼ã‚ºåˆ¥ç§»å‹•æ™‚é–“è¡Œåˆ—ã®çµ±åˆ

**ç›®çš„**: response/transport/returnã§ç•°ãªã‚‹ç§»å‹•æ™‚é–“ã‚’ä½¿ç”¨

**å®Ÿè£…å†…å®¹**:
```python
def _get_travel_time_by_phase(self, from_h3, to_h3, phase):
    """
    ãƒ•ã‚§ãƒ¼ã‚ºã«å¿œã˜ãŸç§»å‹•æ™‚é–“è¡Œåˆ—ã‚’ä½¿ç”¨
    
    phase: 'response', 'transport', 'return'
    """
    matrix = self.travel_time_matrices[phase]  # â˜…ãƒ•ã‚§ãƒ¼ã‚ºåˆ¥
    from_idx = self.grid_mapping[from_h3]
    to_idx = self.grid_mapping[to_h3]
    return matrix[from_idx, to_idx]

def _calculate_ambulance_activity_time(self, ambulance_id, call):
    # Response phase
    response_time = self._get_travel_time_by_phase(
        amb_h3, call_h3, 'response'  # â˜…
    )
    
    # Transport phase
    transport_time = self._get_travel_time_by_phase(
        call_h3, hospital_h3, 'transport'  # â˜…
    )
    
    # Return phase
    return_time = self._get_travel_time_by_phase(
        hospital_h3, station_h3, 'return'  # â˜…
    )
```

**æœŸå¾…åŠ¹æœ**:
- âœ… ç§»å‹•æ™‚é–“ã®ç²¾åº¦å‘ä¸Š
- âœ… ValidationSimulatorã¨ã®ä¸€è‡´ç‡å‘ä¸Š
- âœ… å¹³å‡å¿œç­”æ™‚é–“ã®æ”¹å–„ï¼ˆ21.67åˆ† â†’ 8åˆ†ä»¥ä¸‹ï¼‰

**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**:
- `reinforcement_learning/environment/ems_environment.py`
  - `_calculate_ambulance_activity_time()` ãƒ¡ã‚½ãƒƒãƒ‰
  - `_get_travel_time_by_phase()` ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆæ–°è¦è¿½åŠ ï¼‰

---

### Phase 3: ServiceTimeGeneratorã®å®Œå…¨çµ±åˆ

**ç›®çš„**: ç¢ºç‡çš„ãªã‚µãƒ¼ãƒ“ã‚¹æ™‚é–“ç”Ÿæˆ

**å®Ÿè£…å†…å®¹**:
```python
# æ—¢å­˜ã®ServiceTimeGeneratorEnhancedã‚’ä½¿ç”¨
from data.tokyo.service_time_analysis.service_time_generator_enhanced import ServiceTimeGeneratorEnhanced

def __init__(self, ...):
    # éšå±¤çš„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
    params_path = "data/tokyo/service_time_analysis/lognormal_parameters_hierarchical.json"
    self.service_time_generator = ServiceTimeGeneratorEnhanced(params_path)

def _calculate_ambulance_activity_time(self, ambulance_id, call):
    # ç¾å ´æ´»å‹•æ™‚é–“ï¼ˆç¢ºç‡çš„ï¼‰
    on_scene_time_min = self.service_time_generator.generate_time(
        severity=call['severity'],
        phase='on_scene_time',
        current_time=call['datetime']  # æ™‚åˆ»æƒ…å ±ã‚’æ¸¡ã™
    )
    
    # ç—…é™¢æ´»å‹•æ™‚é–“ï¼ˆç¢ºç‡çš„ï¼‰
    hospital_time_min = self.service_time_generator.generate_time(
        severity=call['severity'],
        phase='hospital_time',
        current_time=call['datetime']
    )
```

**æœŸå¾…åŠ¹æœ**:
- âœ… æ´»å‹•æ™‚é–“ã®å¤‰å‹•æ€§ã‚’å†ç¾
- âœ… å‚·ç—…åº¦åˆ¥ã®æ´»å‹•æ™‚é–“ç‰¹æ€§ã‚’åæ˜ 
- âœ… æ™‚é–“å¸¯ãƒ»åœ°åŸŸã®å½±éŸ¿ã‚’è€ƒæ…®

**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**:
- `reinforcement_learning/environment/ems_environment.py`
  - `_calculate_ambulance_activity_time()` ãƒ¡ã‚½ãƒƒãƒ‰

---

### Phase 4: çŠ¶æ…‹ã‚¨ãƒ³ã‚³ãƒ¼ãƒ€ã®é©å¿œ

**ç›®çš„**: é€£ç¶šæ™‚é–“å¯¾å¿œã®çŠ¶æ…‹ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°

**å®Ÿè£…å†…å®¹**:
```python
# state_encoder.pyã®ä¿®æ­£
def _encode_temporal(self, state_dict):
    """
    æ™‚é–“ç‰¹å¾´é‡ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
    
    å¤‰æ›´ç‚¹: episode_stepã®ä»£ã‚ã‚Šã«current_timeã‚’ä½¿ç”¨
    """
    current_time = state_dict.get('current_time', 0.0)  # ç§’å˜ä½
    
    # ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰é€²è¡Œåº¦ï¼ˆ0â†’1ï¼‰
    episode_duration = self.config['data']['episode_duration_hours'] * 3600
    progress = min(current_time / episode_duration, 1.0)
    
    # æ™‚åˆ»ï¼ˆ0â†’1ï¼‰
    hour_of_day = (current_time / 3600) % 24
    time_of_day = hour_of_day / 24.0
    
    return np.array([progress, time_of_day, ...])
```

**æœŸå¾…åŠ¹æœ**:
- âœ… æ™‚é–“æƒ…å ±ã®æ­£ç¢ºãªè¡¨ç¾
- âœ… ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰é€²è¡Œåº¦ã®é€£ç¶šçš„ãªå¤‰åŒ–
- âœ… å­¦ç¿’ã®å®‰å®šæ€§å‘ä¸Š

**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**:
- `reinforcement_learning/environment/state_encoder.py`
  - `_encode_temporal()` ãƒ¡ã‚½ãƒƒãƒ‰
  - `encode_state()` ãƒ¡ã‚½ãƒƒãƒ‰

---

### Phase 5: å ±é…¬é–¢æ•°ã®èª¿æ•´

**ç›®çš„**: æ–°ã—ã„ç’°å¢ƒã«é©ã—ãŸå ±é…¬è¨­è¨ˆ

**å®Ÿè£…å†…å®¹**:
```python
def _calculate_reward(self, response_time_min, severity):
    """
    é€£ç¶šå ±é…¬é–¢æ•°ï¼ˆæ—¢å­˜ã®RewardDesignerã‚’ä½¿ç”¨ï¼‰
    
    èª¿æ•´ç‚¹:
    - ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒœãƒ¼ãƒŠã‚¹ã®é‡ã¿èª¿æ•´
    - æ™‚é–“ãƒšãƒŠãƒ«ãƒ†ã‚£ã®å‹¾é…èª¿æ•´
    """
    reward = self.reward_designer.calculate_reward({
        'response_time': response_time_min,
        'severity': severity,
        'coverage_ratio': self._calculate_coverage_ratio()
    })
    
    return reward
```

**æœŸå¾…åŠ¹æœ**:
- âœ… ç’°å¢ƒã®ç²¾åº¦å‘ä¸Šã«ä¼´ã†å ±é…¬ã®å†èª¿æ•´
- âœ… å­¦ç¿’ã®åæŸæ€§å‘ä¸Š

**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**:
- `reinforcement_learning/environment/reward_designer.py`ï¼ˆå¾®èª¿æ•´ã®ã¿ï¼‰

---

## ğŸ”§ å®Ÿè£…æ‰‹é †ï¼ˆã‚¹ãƒ†ãƒƒãƒ—ãƒã‚¤ã‚¹ãƒ†ãƒƒãƒ—ï¼‰

### Step 1: æ–°ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆã¨åŸºæœ¬æ§‹é€ ã®å®Ÿè£…

```bash
# è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‹ã‚‰å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
cp reinforcement_learning/environment/ems_environment_v2_design.py \
   reinforcement_learning/environment/ems_environment_v2.py
```

**å®Ÿè£…å†…å®¹**:
1. ã‚¤ãƒ™ãƒ³ãƒˆã‚¯ãƒ©ã‚¹ã®å®šç¾©
2. ã‚¤ãƒ™ãƒ³ãƒˆã‚­ãƒ¥ãƒ¼ã®ç®¡ç†æ©Ÿèƒ½
3. åŸºæœ¬çš„ãªã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ãƒ«ãƒ¼ãƒ—

**æœŸé–“**: 1æ—¥

---

### Step 2: ValidationSimulatoräº’æ›ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ç§»æ¤

**å®Ÿè£…å†…å®¹**:
1. ãƒ•ã‚§ãƒ¼ã‚ºåˆ¥ç§»å‹•æ™‚é–“è¡Œåˆ—ã®èª­ã¿è¾¼ã¿
2. ServiceTimeGeneratorã®çµ±åˆ
3. ç—…é™¢é¸æŠãƒ¢ãƒ‡ãƒ«ã®çµ±åˆ

**ä¿®æ­£ç®‡æ‰€**:
- `_load_travel_time_matrices()`: 3ã¤ã®è¡Œåˆ—ã‚’èª­ã¿è¾¼ã‚€
- `_get_travel_time_by_phase()`: ãƒ•ã‚§ãƒ¼ã‚ºæŒ‡å®šå¯¾å¿œ
- `_calculate_ambulance_activity_time()`: è©³ç´°è¨ˆç®—

**æœŸé–“**: 2æ—¥

---

### Step 3: PPOå­¦ç¿’ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®å®Ÿè£…

**å®Ÿè£…å†…å®¹**:
1. `step()` ãƒ¡ã‚½ãƒƒãƒ‰ã®å®Ÿè£…
2. `reset()` ãƒ¡ã‚½ãƒƒãƒ‰ã®å®Ÿè£…
3. `get_action_mask()` ã®å®Ÿè£…
4. äº‹æ¡ˆã‚¤ãƒ™ãƒ³ãƒˆã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°

**æœŸé–“**: 2æ—¥

---

### Step 4: å˜ä½“ãƒ†ã‚¹ãƒˆã¨çµ±åˆãƒ†ã‚¹ãƒˆ

```python
# test_ems_environment_v2.py
def test_event_driven_time_management():
    """ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•æ™‚é–“ç®¡ç†ã®ãƒ†ã‚¹ãƒˆ"""
    env = ValidationIntegratedEMSEnvironment(...)
    env.reset()
    
    # å…¨è»Šå‡ºå‹•ä¸­ã®é »åº¦ã‚’ãƒ†ã‚¹ãƒˆ
    all_busy_count = 0
    for _ in range(1000):
        mask = env.get_action_mask()
        if not mask.any():
            all_busy_count += 1
        # ...
    
    assert all_busy_count < 10, f"å…¨è»Šå‡ºå‹•ä¸­ãŒå¤šã™ãã‚‹: {all_busy_count}å›"

def test_phase_specific_travel_times():
    """ãƒ•ã‚§ãƒ¼ã‚ºåˆ¥ç§»å‹•æ™‚é–“ã®ãƒ†ã‚¹ãƒˆ"""
    env = ValidationIntegratedEMSEnvironment(...)
    
    # response, transport, returnã§ç•°ãªã‚‹æ™‚é–“ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    response_time = env._get_travel_time_by_phase(h3_a, h3_b, 'response')
    transport_time = env._get_travel_time_by_phase(h3_a, h3_b, 'transport')
    return_time = env._get_travel_time_by_phase(h3_a, h3_b, 'return')
    
    # é€šå¸¸ã€response < transportï¼ˆç·Šæ€¥èµ°è¡Œ vs é€šå¸¸èµ°è¡Œï¼‰
    assert response_time <= transport_time

def test_service_time_generation():
    """ã‚µãƒ¼ãƒ“ã‚¹æ™‚é–“ç”Ÿæˆã®ãƒ†ã‚¹ãƒˆ"""
    env = ValidationIntegratedEMSEnvironment(...)
    
    # é‡ç—‡ã¨è»½ç—‡ã§ç•°ãªã‚‹æ™‚é–“ãŒç”Ÿæˆã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    critical_times = [
        env.service_time_generator.generate_time('é‡ç—‡', 'on_scene_time', datetime.now())
        for _ in range(100)
    ]
    mild_times = [
        env.service_time_generator.generate_time('è»½ç—‡', 'on_scene_time', datetime.now())
        for _ in range(100)
    ]
    
    # é‡ç—‡ã®æ–¹ãŒæ´»å‹•æ™‚é–“ãŒé•·ã„å‚¾å‘
    assert np.mean(critical_times) > np.mean(mild_times)
```

**æœŸé–“**: 2æ—¥

---

### Step 5: ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æ›´æ–°

```python
# train_ppo_v2.py
from reinforcement_learning.environment.ems_environment_v2 import ValidationIntegratedEMSEnvironment

def main():
    # æ–°ã—ã„ç’°å¢ƒã‚’ä½¿ç”¨
    env = ValidationIntegratedEMSEnvironment(
        config_path="reinforcement_learning/experiments/config_continuous.yaml",
        mode="train"
    )
    
    # ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ã®åˆæœŸåŒ–ï¼ˆæ—¢å­˜ã®Trainerã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨å¯èƒ½ï¼‰
    trainer = PPOTrainer(
        env=env,
        config=config
    )
    
    # å­¦ç¿’å®Ÿè¡Œ
    trainer.train()
```

**æœŸé–“**: 1æ—¥

---

### Step 6: æ¯”è¼ƒå®Ÿé¨“ã¨æ¤œè¨¼

**å®Ÿé¨“å†…å®¹**:
1. **æ—§ç’°å¢ƒ vs æ–°ç’°å¢ƒã®æ¯”è¼ƒ**
   - å…¨è»Šå‡ºå‹•ä¸­é »åº¦
   - å¹³å‡å¿œç­”æ™‚é–“
   - 6åˆ†é”æˆç‡

2. **æ–°ç’°å¢ƒ vs ValidationSimulatorã®æ¯”è¼ƒ**
   - åŒã˜äº‹æ¡ˆãƒ‡ãƒ¼ã‚¿ã§å®Ÿè¡Œ
   - çµ±è¨ˆæŒ‡æ¨™ã®ä¸€è‡´åº¦ç¢ºèª

**æ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆ**:
```python
# compare_environments.py
def compare_old_vs_new():
    """æ—§ç’°å¢ƒã¨æ–°ç’°å¢ƒã®æ¯”è¼ƒ"""
    # æ—§ç’°å¢ƒ
    env_old = EMSEnvironment(config_path, mode="eval")
    stats_old = run_episode(env_old)
    
    # æ–°ç’°å¢ƒ
    env_new = ValidationIntegratedEMSEnvironment(config_path, mode="eval")
    stats_new = run_episode(env_new)
    
    print("æ¯”è¼ƒçµæœ:")
    print(f"  å…¨è»Šå‡ºå‹•ä¸­: {stats_old['all_busy_count']}å› â†’ {stats_new['all_busy_count']}å›")
    print(f"  å¹³å‡å¿œç­”æ™‚é–“: {stats_old['mean_response']:.2f}åˆ† â†’ {stats_new['mean_response']:.2f}åˆ†")
    print(f"  6åˆ†é”æˆç‡: {stats_old['6min_rate']:.1f}% â†’ {stats_new['6min_rate']:.1f}%")
```

**æœŸé–“**: 2æ—¥

---

## ğŸ“Š ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æˆ¦ç•¥

### ã‚ªãƒ—ã‚·ãƒ§ãƒ³1: æ®µéšçš„ç§»è¡Œï¼ˆæ¨å¥¨ï¼‰

```
Week 1: Phase 1å®Ÿè£… â†’ ãƒ†ã‚¹ãƒˆ
Week 2: Phase 2-3å®Ÿè£… â†’ ãƒ†ã‚¹ãƒˆ
Week 3: Phase 4-5å®Ÿè£… â†’ çµ±åˆãƒ†ã‚¹ãƒˆ
Week 4: æ¯”è¼ƒå®Ÿé¨“ â†’ æœ¬ç•ªç§»è¡Œ
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- âœ… ãƒªã‚¹ã‚¯åˆ†æ•£
- âœ… å„æ®µéšã§æ¤œè¨¼å¯èƒ½
- âœ… å•é¡Œã®æ—©æœŸç™ºè¦‹

### ã‚ªãƒ—ã‚·ãƒ§ãƒ³2: ä¸¦è¡Œé–‹ç™º

```
æ—§ç’°å¢ƒ: ems_environment.pyï¼ˆç¶­æŒï¼‰
æ–°ç’°å¢ƒ: ems_environment_v2.pyï¼ˆé–‹ç™ºï¼‰
â†’ æ¤œè¨¼å®Œäº†å¾Œã«ç½®ãæ›ãˆ
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- âœ… æ—¢å­˜ã®å­¦ç¿’ã‚’ç¶™ç¶šå¯èƒ½
- âœ… æ¯”è¼ƒå®Ÿé¨“ãŒå®¹æ˜“

---

## âš ï¸ ãƒªã‚¹ã‚¯ã¨å¯¾ç­–

### ãƒªã‚¹ã‚¯1: å­¦ç¿’ã®ä¸å®‰å®šåŒ–

**åŸå› **: ç’°å¢ƒã®ç²¾åº¦å‘ä¸Šã«ã‚ˆã‚Šã€é›£æ˜“åº¦ãŒä¸Šæ˜‡

**å¯¾ç­–**:
- ãƒã‚¤ãƒ‘ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å†èª¿æ•´ï¼ˆå­¦ç¿’ç‡ã€ã‚¨ãƒ³ãƒˆãƒ­ãƒ”ãƒ¼ä¿‚æ•°ï¼‰
- ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ å­¦ç¿’ã®å°å…¥ï¼ˆç°¡å˜ãªäº‹æ¡ˆã‹ã‚‰é–‹å§‹ï¼‰

### ãƒªã‚¹ã‚¯2: è¨ˆç®—ã‚³ã‚¹ãƒˆã®å¢—åŠ 

**åŸå› **: ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•å‡¦ç†ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰

**å¯¾ç­–**:
- ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã®æœ€é©åŒ–
- ä¸¦åˆ—åŒ–ã®æ¤œè¨ï¼ˆè¤‡æ•°ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã®ä¸¦è¡Œå®Ÿè¡Œï¼‰

### ãƒªã‚¹ã‚¯3: æ—¢å­˜ãƒ¢ãƒ‡ãƒ«ã®äº’æ›æ€§å–ªå¤±

**åŸå› **: çŠ¶æ…‹è¡¨ç¾ã®å¤‰æ›´

**å¯¾ç­–**:
- æ–°ç’°å¢ƒã§å†å­¦ç¿’ï¼ˆé¿ã‘ã‚‰ã‚Œãªã„ï¼‰
- Transfer Learningã®æ¤œè¨

---

## ğŸ“ˆ æˆåŠŸæŒ‡æ¨™

### çŸ­æœŸï¼ˆPhase 1-3å®Œäº†æ™‚ï¼‰

| æŒ‡æ¨™ | ç›®æ¨™å€¤ |
|------|--------|
| å…¨è»Šå‡ºå‹•ä¸­é »åº¦ | 10å›ä»¥ä¸‹/ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ |
| å¹³å‡å¿œç­”æ™‚é–“ | 10åˆ†ä»¥ä¸‹ |
| å˜ä½“ãƒ†ã‚¹ãƒˆé€šéç‡ | 100% |

### ä¸­æœŸï¼ˆPhase 4-5å®Œäº†æ™‚ï¼‰

| æŒ‡æ¨™ | ç›®æ¨™å€¤ |
|------|--------|
| 6åˆ†é”æˆç‡ | 30%ä»¥ä¸Š |
| ValidationSimulatorã¨ã®å¿œç­”æ™‚é–“å·® | Â±10%ä»¥å†… |
| å­¦ç¿’ã®åæŸ | 100ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ä»¥å†… |

### é•·æœŸï¼ˆæœ¬ç•ªé‹ç”¨æ™‚ï¼‰

| æŒ‡æ¨™ | ç›®æ¨™å€¤ |
|------|--------|
| ValidationSimulatorã¨ã®æ€§èƒ½å·® | Â±5%ä»¥å†… |
| 6åˆ†é”æˆç‡ | 40%ä»¥ä¸Š |
| å­¦ç¿’ã®å®‰å®šæ€§ | 1000ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰é€£ç¶šåæŸ |

---

## ğŸ¯ æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

1. **å³åº§ã«å®Ÿæ–½**:
   - âœ… è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆå®Œäº†ï¼‰
   - â¬œ Phase 1ã®å®Ÿè£…é–‹å§‹ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ã‚³ã‚¢ï¼‰

2. **ä»Šé€±ä¸­**:
   - â¬œ Phase 1ã®å˜ä½“ãƒ†ã‚¹ãƒˆ
   - â¬œ Phase 2ã®å®Ÿè£…é–‹å§‹

3. **æ¥é€±**:
   - â¬œ Phase 3-4ã®å®Ÿè£…
   - â¬œ çµ±åˆãƒ†ã‚¹ãƒˆ

4. **2é€±é–“å¾Œ**:
   - â¬œ Phase 5ã®å®Ÿè£…
   - â¬œ æ¯”è¼ƒå®Ÿé¨“ã®å®Ÿæ–½
   - â¬œ æœ¬ç•ªç’°å¢ƒã¸ã®ç§»è¡Œåˆ¤æ–­

---

## ğŸ“š å‚è€ƒè³‡æ–™

1. **reportãƒ•ã‚¡ã‚¤ãƒ«**:
   - `old/bu/detailed_analysis_report.md`: æ™‚é–“ç®¡ç†å•é¡Œã®è©³ç´°åˆ†æ
   - `old/bu/ems_environment_investigation_report.md`: å­¦ç¿’åæŸå•é¡Œã®èª¿æŸ»

2. **æ—¢å­˜å®Ÿè£…**:
   - `validation_simulation.py`: ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®å‚è€ƒå®Ÿè£…
   - `old/bu/ems_environment1027.py`: å…ƒã®ã‚¹ãƒ†ãƒƒãƒ—ãƒ™ãƒ¼ã‚¹å®Ÿè£…

3. **è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**:
   - `reinforcement_learning/environment/ems_environment_v2_design.py`: æ–°ã—ã„ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®è©³ç´°

---

## ğŸ’¬ è³ªå•ã¨å›ç­”

**Q1: ãªãœæ—¢å­˜ã®ç’°å¢ƒã‚’ä¿®æ­£ã™ã‚‹ã®ã§ã¯ãªãã€æ–°ã—ãä½œã‚Šç›´ã™ã®ã‹ï¼Ÿ**

A: æ™‚é–“ç®¡ç†ã®æ ¹æœ¬çš„ãªã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãŒç•°ãªã‚‹ãŸã‚ã€éƒ¨åˆ†çš„ãªä¿®æ­£ã§ã¯å¯¾å¿œã§ãã¾ã›ã‚“ã€‚ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•å‹ã¸ã®å¤‰æ›´ã¯å…¨ä½“ã®å†è¨­è¨ˆãŒå¿…è¦ã§ã™ã€‚

**Q2: æ—¢å­˜ã®ãƒ¢ãƒ‡ãƒ«ã¯ä½¿ãˆãªããªã‚‹ã®ã‹ï¼Ÿ**

A: çŠ¶æ…‹è¡¨ç¾ãŒå¤‰ã‚ã‚‹ãŸã‚ã€æ—¢å­˜ãƒ¢ãƒ‡ãƒ«ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚ãŸã ã—ã€æ–°ç’°å¢ƒã®æ–¹ãŒç²¾åº¦ãŒé«˜ã„ãŸã‚ã€å†å­¦ç¿’ã«ã‚ˆã‚Šæ€§èƒ½å‘ä¸ŠãŒæœŸå¾…ã§ãã¾ã™ã€‚

**Q3: ValidationSimulatorã¨ã®å®Œå…¨ãªä¸€è‡´ã¯å¯èƒ½ã‹ï¼Ÿ**

A: ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ¬ãƒ™ãƒ«ã§ã¯ä¸€è‡´ã—ã¾ã™ãŒã€ä¹±æ•°ã‚·ãƒ¼ãƒ‰ã®é•ã„ãªã©ã«ã‚ˆã‚Šã€å€‹åˆ¥ã®äº‹æ¡ˆãƒ¬ãƒ™ãƒ«ã§ã¯å·®ç•°ãŒç”Ÿã˜ã¾ã™ã€‚çµ±è¨ˆçš„ãªä¸€è‡´ï¼ˆÂ±5%ï¼‰ã‚’ç›®æ¨™ã¨ã—ã¾ã™ã€‚

**Q4: å®Ÿè£…ã«ã©ã®ãã‚‰ã„ã®æœŸé–“ãŒã‹ã‹ã‚‹ã‹ï¼Ÿ**

A: æ®µéšçš„å®Ÿè£…ã§3-4é€±é–“ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚Phase 1ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ã‚³ã‚¢ï¼‰ãŒæœ€ã‚‚é‡è¦ã§ã€1é€±é–“ç¨‹åº¦ã§å®Œäº†äºˆå®šã§ã™ã€‚

---

**æ‰¿èªè€…**: _______________  **æ—¥ä»˜**: _______________

