# experiments/config_test.yaml
# 小規模テスト用の設定ファイル
# ================================================================
# 実験設定
# ================================================================
experiment:
  name: "ppo_test_run"
  seed: 42
  device: "cuda"  # GPUが無い場合は "cpu" に変更

# ================================================================
# データ設定（テスト用に期間とエピソード長を短縮）
# ================================================================
data:
  # 学習用データ期間（3日分に拡張）
  train_periods:
    - start_date: "20230401"
      end_date: "20230403"  # 3日分
  
  # 評価用データ期間  
  eval_periods:
    - start_date: "20230404"
      end_date: "20230404"  # 1日のみ
  
  # シミュレーション設定
  episode_duration_hours: 8  # 8時間のエピソード（拡張）

# ================================================================
# 傷病度設定（本番と同じ）
# ================================================================
severity:
  categories:
    critical:
      conditions: ["重篤", "重症", "死亡"]
      reward_weight: 5.0
      time_limit_seconds: 360
    moderate:
      conditions: ["中等症"]
      reward_weight: 2.0
      time_limit_seconds: 480
    mild:
      conditions: ["軽症"]
      reward_weight: 1.0
      time_limit_seconds: 780
  
  thresholds:
    golden_time: 360
    standard_time: 780

# ================================================================
# PPOハイパーパラメータ（テスト用に削減）
# ================================================================
ppo:
  n_episodes: 50  # 50エピソードのみ
  n_epochs: 3  # エポック数も削減
  batch_size: 16  # バッチサイズ縮小
  clip_epsilon: 0.2
  gamma: 0.99
  gae_lambda: 0.95
  learning_rate:
    actor: 0.0003
    critic: 0.0003
    scheduler: "constant"
  entropy_coef: 0.01

# ================================================================
# 報酬関数設定（テスト用に調整）
# ================================================================
reward:
  weights:
    response_time: -1.0
    severity_bonus: 2.0
    threshold_penalty: -5.0  # -10.0 → -5.0 に緩和
    coverage_preservation: 0.5
  penalties:
    over_6min: -3.0  # -5.0 → -3.0 に緩和
    over_13min: -10.0  # -20.0 → -10.0 に緩和
    per_minute_over: -0.5  # -1.0 → -0.5 に緩和

# ================================================================
# ネットワーク構造（シンプル化）
# ================================================================
network:
  state_encoder:
    ambulance_features: 4
    incident_features: 10
    spatial_features: 20
    temporal_features: 8
  
  actor:
    hidden_layers: [128, 64]  # 層を削減
    activation: "relu"
    dropout: 0.1
  
  critic:
    hidden_layers: [128, 64]  # 層を削減
    activation: "relu"
    dropout: 0.1

# ================================================================
# 学習管理
# ================================================================
training:
  checkpoint_interval: 20  # 20エピソードごと
  keep_last_n: 3
  early_stopping:
    enabled: false  # テストでは無効化
    patience: 100
    min_delta: 0.001
  logging:
    interval: 5  # 5エピソードごとにログ
    tensorboard: false  # テストでは無効化
    wandb: false

# ================================================================
# 評価設定
# ================================================================
evaluation:
  interval: 10  # 10エピソードごと
  n_eval_episodes: 2  # 評価は2エピソード
  metrics:
    - "mean_response_time"
    - "6min_achievement_rate"
    - "13min_achievement_rate"
  compare_baselines:
    - "closest"