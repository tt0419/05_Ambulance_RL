# config_tokyo23_hybrid.yaml
# æ±äº¬23åŒºå…¨åŸŸã§ã®ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãƒ¢ãƒ¼ãƒ‰å®Ÿé¨“ç”¨è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
# ãƒ™ãƒ¼ã‚¹: config_tokyo23.yamlã®è¨­å®šã‚’ç¶™æ‰¿ã—ã€ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãƒ¢ãƒ¼ãƒ‰æ©Ÿèƒ½ã‚’è¿½åŠ 

# ãƒ™ãƒ¼ã‚¹è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¶™æ‰¿
inherits: ./config.yaml

# ===================================================================
# ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãƒ¢ãƒ¼ãƒ‰æˆ¦ç•¥
# é‡ç—‡ç³»ï¼ˆé‡ç—‡ãƒ»é‡ç¯¤ãƒ»æ­»äº¡ï¼‰: ç›´è¿‘éšŠé‹ç”¨ã§ç¢ºå®Ÿã«å¯¾å¿œ
# è»½ç—‡ç³»ï¼ˆè»½ç—‡ãƒ»ä¸­ç­‰ç—‡ï¼‰: PPOå­¦ç¿’ã§åŠ¹ç‡çš„ãªé…ç½®ã‚’å­¦ç¿’
# ===================================================================

# ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¹è¨­å®šï¼ˆPPOæˆ¦ç•¥ã®åˆæœŸåŒ–ã«å¿…è¦ï¼‰
data_paths:
  grid_mapping: "data/tokyo/processed/grid_mapping_res9.json"
  travel_time_matrix: "data/tokyo/calibration2/linear_calibrated_response.npy"

experiment:
  name: "hybrid_ppo_0930175329_v2"
  description: "0930175329ãƒ™ãƒ¼ã‚¹ã«æ–°ç’°å¢ƒã§å®Ÿé¨“ã€‚å¿œç­”æ™‚é–“é‡è¦–ã€ã‚«ãƒãƒ¬ãƒƒã‚¸ã¯è£œåŠ©"
  seed: 42
  device: cuda

# -------------------------------------------------------------------
# å ±é…¬ãƒ¢ãƒ¼ãƒ‰è¨­å®šï¼ˆreward_mode.modeã§å ±é…¬è¨ˆç®—ãƒ¢ãƒ¼ãƒ‰ã‚’æŒ‡å®šï¼‰
# -------------------------------------------------------------------
reward_mode:
  mode: hybrid  # hybridãƒ¢ãƒ¼ãƒ‰ã‚’ä½¿ç”¨

# -------------------------------------------------------------------
# ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãƒ¢ãƒ¼ãƒ‰è¨­å®šï¼ˆems_environmentç”¨ï¼‰
# -------------------------------------------------------------------
hybrid_mode:
  enabled: true
  
  # å‚·ç—…åº¦åˆ†é¡
  severity_classification:
    severe_conditions: ["é‡ç—‡", "é‡ç¯¤", "æ­»äº¡"]  # ç›´è¿‘éšŠé‹ç”¨ï¼ˆå­¦ç¿’å¯¾è±¡å¤–ï¼‰
    mild_conditions: ["è»½ç—‡", "ä¸­ç­‰ç—‡"]           # PPOå­¦ç¿’å¯¾è±¡

  reward_weights:
    response_time: 0.7      # ğŸ”¥ 0.4 â†’ 0.7ï¼ˆå¿œç­”æ™‚é–“æœ€å„ªå…ˆï¼‰
    coverage: 0.2           # ğŸ”¥ 0.5 â†’ 0.2ï¼ˆã‚«ãƒãƒ¬ãƒƒã‚¸ã¯è£œåŠ©ï¼‰
    workload_balance: 0.1

# -------------------------------------------------------------------
# ãƒ‡ãƒ¼ã‚¿è¨­å®š (config_tokyo23.yamlã‹ã‚‰ç¶™æ‰¿)
# -------------------------------------------------------------------
data:
  area_restriction:
    enabled: true
    area_name: "æ±äº¬23åŒº"
    section_code: null
    districts: [
      "åƒä»£ç”°åŒº", "ä¸­å¤®åŒº", "æ¸¯åŒº", "æ–°å®¿åŒº", "æ–‡äº¬åŒº", "å°æ±åŒº", 
      "å¢¨ç”°åŒº", "æ±Ÿæ±åŒº", "å“å·åŒº", "ç›®é»’åŒº", "å¤§ç”°åŒº", "ä¸–ç”°è°·åŒº", 
      "æ¸‹è°·åŒº", "ä¸­é‡åŒº", "æ‰ä¸¦åŒº", "è±Šå³¶åŒº", "åŒ—åŒº", "è’å·åŒº", 
      "æ¿æ©‹åŒº", "ç·´é¦¬åŒº", "è¶³ç«‹åŒº", "è‘›é£¾åŒº", "æ±Ÿæˆ¸å·åŒº"
    ]
    # æ¬¡å…ƒæ•°ã‚’æ˜ç¤ºçš„ã«å®šç¾©
    num_ambulances_in_area: 192
    state_dim: 999  # ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãƒ¢ãƒ¼ãƒ‰ã§ã‚‚åŒã˜çŠ¶æ…‹ç©ºé–“
    action_dim: 192

  max_steps_per_episode: 3000  
  episode_duration_hours: 24
  
  # å­¦ç¿’æœŸé–“ï¼ˆè»½ç—‡ç³»ãŒå¤šã„æœŸé–“ã¨ç¹å¿™æœŸã®ä¸¡æ–¹ã‚’å«ã‚€ï¼‰
  train_periods:
    - start_date: "20230615"
      end_date: "20230615"    # 10æ—¥é–“ã«å»¶é•·
    # - start_date: "20231201"  # ç¹å¿™æœŸãƒ‡ãƒ¼ã‚¿è¿½åŠ 
    #   end_date: "20240131"
  
  eval_periods:
    - start_date: "20230615"
      end_date: "20230615"

# -------------------------------------------------------------------
# PPOãƒã‚¤ãƒ‘ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ (è»½ç—‡ç³»å­¦ç¿’ã«æœ€é©åŒ–)
# -------------------------------------------------------------------
ppo:
  n_episodes: 5000  # é‡ç—‡ç³»ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ãŸã‚ã€ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰æ•°ã‚’å‰Šæ¸›å¯èƒ½
  batch_size: 1024
  
  # å­¦ç¿’ç‡ï¼ˆconfig_tokyo23.yamlã®è¨­å®šã‚’åŸºæœ¬çš„ã«ç¶™æ‰¿ï¼‰
  learning_rate:
    actor: 0.0003
    critic: 0.001  # Criticã‚’é«˜ã‚ã«ç¶­æŒ
    scheduler: constant
  
  # PPOãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
  n_epochs: 6  # å­¦ç¿’å¯¾è±¡ãŒæ¸›ã‚‹ãŸã‚ã€ã‚¨ãƒãƒƒã‚¯æ•°ã‚’å°‘ã—å¢—ã‚„ã™
  clip_epsilon: 0.1
  gamma: 0.99
  gae_lambda: 0.95
  entropy_coef: 0.015  # è»½ç—‡ç³»ã®å¤šæ§˜ãªé…ç½®ã‚’æ¢ç´¢
  max_grad_norm: 0.5

# -------------------------------------------------------------------
# å ±é…¬è¨­è¨ˆ (ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãƒ¢ãƒ¼ãƒ‰ç”¨ã«èª¿æ•´)
# -------------------------------------------------------------------
reward:
  # ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«è¨­å®šã¯ç¶™æ‰¿
  system:
    dispatch_failure: -1.0
    no_available_ambulance: 0.0
    unhandled_call_penalty: -1.0
  
  # ã‚³ã‚¢å ±é…¬è¨­å®šï¼ˆãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãƒ¢ãƒ¼ãƒ‰ç”¨ï¼‰
  core:
    mode: "hybrid"  # ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãƒ¢ãƒ¼ãƒ‰ã‚’ä½¿ç”¨
    
    # ã‚«ãƒãƒ¬ãƒƒã‚¸å½±éŸ¿é‡ã¿ï¼ˆé‡è¦ï¼ï¼‰
    coverage_impact_weight: 0.5  # ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’å ±é…¬ã«åæ˜ ï¼ˆå…ƒã®è¨­è¨ˆï¼‰
    
    # è»½ç—‡ç³»ç”¨ã®ã‚·ãƒ³ãƒ—ãƒ«ãªå ±é…¬ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
    hybrid_params:
      # åŸºæœ¬æ™‚é–“ãƒšãƒŠãƒ«ãƒ†ã‚£ï¼ˆè»½ç—‡ç³»ã®ã¿é©ç”¨ï¼‰
      time_penalty_per_minute: -1.0  # config_tokyo23ã‚ˆã‚Šè»½ã‚
      
      # è»½ç—‡ç³»é”æˆãƒœãƒ¼ãƒŠã‚¹n
      mild_under_13min_bonus: 5.0
      moderate_under_13min_bonus: 10.0
      
      # é–¾å€¤è¶…éãƒšãƒŠãƒ«ãƒ†ã‚£
      over_13min_penalty: -20.0
      over_20min_penalty: -100.0  # 20åˆ†è¶…éã¯é‡ã„ãƒšãƒŠãƒ«ãƒ†ã‚£
      
      # ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒœãƒ¼ãƒŠã‚¹ï¼ˆé‡ç—‡ç³»ã¸ã®æº–å‚™åº¦ï¼‰
      good_coverage_bonus: 10.0  # ã‚«ãƒãƒ¬ãƒƒã‚¸0.8ä»¥ä¸Š
      coverage_maintenance_bonus: 5.0  # ã‚«ãƒãƒ¬ãƒƒã‚¸0.6-0.8
      poor_coverage_penalty: -10.0  # ã‚«ãƒãƒ¬ãƒƒã‚¸0.6æœªæº€
      
      # ç¨¼åƒãƒãƒ©ãƒ³ã‚¹ãƒœãƒ¼ãƒŠã‚¹
      balanced_workload_bonus: 2.0
      overloaded_penalty: -5.0  # ç‰¹å®šæ•‘æ€¥è»Šã®éè² è·
  
  # ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆé‡ç—‡ç³»ã¸ã®æº–å‚™åº¦è©•ä¾¡ç”¨ï¼‰
  coverage_params:
    time_threshold_seconds: 360  # 6åˆ†ï¼ˆé‡ç—‡ç³»ã®ç›®æ¨™æ™‚é–“ï¼‰
    high_risk_areas: []  # å®Ÿè¡Œæ™‚ã«å‹•çš„ã«è¨ˆç®—
    evaluation_interval: 100  # 100ã‚¤ãƒ™ãƒ³ãƒˆã”ã¨ã«è©•ä¾¡
  
  # ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰å ±é…¬ï¼ˆç°¡ç•¥åŒ–ï¼‰
  episode:
    base_penalty_per_minute: -0.3
    achievement_bonuses:
      # é‡ç—‡ç³»ï¼ˆç›´è¿‘éšŠé‹ç”¨ã®çµæœã‚’è©•ä¾¡ï¼‰
      severe_6min_rate: 50.0  # é‡ç—‡ç³»6åˆ†ä»¥å†…ç‡ãƒœãƒ¼ãƒŠã‚¹
      # è»½ç—‡ç³»ï¼ˆPPOå­¦ç¿’ã®çµæœã‚’è©•ä¾¡ï¼‰
      mild_13min_rate: 30.0
      mild_under_20min_rate: 20.0  # 20åˆ†ä»¥å†…ç‡ãƒœãƒ¼ãƒŠã‚¹
    failure_penalty_per_incident: -1.0

# -------------------------------------------------------------------
# æ•™å¸«ã‚ã‚Šå­¦ç¿’ (è»½ç—‡ç³»ã®ã¿ã«é©ç”¨)
# -------------------------------------------------------------------
teacher:
  enabled: false
  strategy: closest
  
  # ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãƒ¢ãƒ¼ãƒ‰ç”¨ï¼šè»½ç—‡ç³»ã®ã¿æ•™å¸«å­¦ç¿’
  apply_to: ["è»½ç—‡", "ä¸­ç­‰ç—‡"]  # è»½ç—‡ç³»ã®ã¿
  
  # ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ ï¼ˆè»½ç—‡ç³»ã®å­¦ç¿’ã‚’å®‰å®šåŒ–ï¼‰
  initial_prob: 0.3   # è»½ç—‡ç³»ã®30%ã‚’åˆæœŸã¯æ¨¡å€£
  final_prob: 0.05    # æœ€çµ‚çš„ã«5%ã¾ã§æ¸›å°‘
  decay_episodes: 2000

# -------------------------------------------------------------------
# ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®š (config_tokyo23.yamlã‹ã‚‰ç¶™æ‰¿)
# -------------------------------------------------------------------
network:
  actor:
    hidden_layers: [256, 128]
    activation: relu
    initialization: xavier_uniform
  critic:
    hidden_layers: [256, 128]
    activation: relu
    init_scale: 0.001

# -------------------------------------------------------------------
# è©•ä¾¡è¨­å®š (ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãƒ¢ãƒ¼ãƒ‰ç”¨ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¿½åŠ )
# -------------------------------------------------------------------
evaluation:
  interval: 100  # è©•ä¾¡é–“éš”ã‚’çŸ­ã
  n_eval_episodes: 5
  compare_baselines: ["closest", "severity_based"]
  
  # ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãƒ¢ãƒ¼ãƒ‰å°‚ç”¨ãƒ¡ãƒˆãƒªã‚¯ã‚¹
  metrics:
    # é‡ç—‡ç³»ï¼ˆç›´è¿‘éšŠé‹ç”¨ï¼‰
    - "severe_6min_rate"
    - "severe_mean_rt"
    - "critical_6min_rate"
    
    # è»½ç—‡ç³»ï¼ˆPPOå­¦ç¿’ï¼‰
    - "mild_13min_rate"
    - "mild_20min_rate"
    - "mild_mean_rt"
    
    # å…¨ä½“è©•ä¾¡
    - "overall_13min_rate"
    - "overall_mean_rt"
    - "coverage_score"
    - "workload_balance"
    
    # æ¯”è¼ƒ
    - "vs_closest_improvement"
    - "dispatch_ratio"  # ç›´è¿‘éšŠ vs PPO ã®æ¯”ç‡

# -------------------------------------------------------------------
# å­¦ç¿’ç®¡ç†
# -------------------------------------------------------------------
training:
  checkpoint_interval: 100
  early_stopping:
    enabled: true
    patience: 10
    # metric: "mild_20min_rate"  # 20åˆ†è¶…éç‡ã‚’ç›£è¦–
    # mode: "min"  # æœ€å°åŒ–
    min_delta: 2.0
  
  logging:
    interval: 500
    wandb: true
    wandb_project: "ems_hybrid_tokyo23"
    
    # ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãƒ¢ãƒ¼ãƒ‰ç”¨ãƒ­ã‚°
    hybrid_logs:
      - "severe_dispatch_count"
      - "mild_dispatch_count"
      - "coverage_history"
      - "warning_episodes"  # 20åˆ†è¶…éã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰