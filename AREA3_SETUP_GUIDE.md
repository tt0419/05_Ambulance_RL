# 第3方面限定環境セットアップガイド

このガイドでは、東京消防庁第3方面本部（目黒区、渋谷区、世田谷区）に限定したPPO学習環境の使用方法を説明します。

## 目的

全23区での学習は規模が大きすぎて収束が困難なため、第3方面に限定して段階的に学習を行います。

## 設定の概要

### 1. 事案の限定
- **対象エリア**: 目黒区、渋谷区、世田谷区
- **データフィルタ**: `出場先区市`カラムによる事案限定
- **データ削減効果**: 約10分の1に削減（全23区比）

### 2. 救急車の限定
- **対象救急車**: `section=3`の救急隊のみ
- **予想台数**: 15-20台程度
- **行動空間**: 192台 → 15-20台に大幅削減

### 3. 病院選択
- **対象病院**: 全ての病院（変更なし）
- **理由**: 搬送選択肢を制限すると総活動時間が現実と乖離する可能性

## ファイル構成

### 新規・変更ファイル

1. **data_cache.py** (変更)
   - `get_period_data()`にエリアフィルタ機能を追加
   - 第3方面の事案のみを抽出

2. **ems_environment.py** (変更)
   - 救急車データのフィルタリング機能を追加
   - 状態・行動空間の動的計算
   - 第3方面設定時は`section=3`の救急車のみ使用

3. **config_area3.yaml** (更新)
   - 第3方面の実際の規模に合わせた設定
   - 救急車数15-20台に適したネットワーク構造
   - 最適化されたハイパーパラメータ

4. **test_area3_environment.py** (新規)
   - 第3方面限定環境のテストスクリプト
   - データ規模の確認、環境の動作検証

5. **train_area3_ppo.py** (新規)
   - 第3方面限定学習の実行スクリプト
   - 事前チェック機能付き

## 使用方法

### 1. 環境テスト

```bash
python test_area3_environment.py
```

以下の項目がテストされます：
- データキャッシュの動作
- 第3方面事案のフィルタリング
- 救急車データの限定
- 環境の初期化
- 1ステップの実行

### 2. 学習実行

#### 方法A: 専用スクリプト使用
```bash
python train_area3_ppo.py
```

#### 方法B: 直接実行
```bash
python train_ppo.py --config reinforcement_learning/experiments/config_area3.yaml
```

### 3. 学習結果の確認

学習結果は以下に保存されます：
```
reinforcement_learning/experiments/ppo_training/area3_[timestamp]/
├── checkpoints/        # モデルのチェックポイント
├── configs/           # 使用した設定ファイル
├── logs/              # 学習ログ
└── visualizations/    # 学習曲線等の可視化
```

## 期待される効果

### 学習の安定化
- **事案数**: 約10分の1に削減
- **救急車数**: 192台 → 15-20台
- **状態空間**: 大幅に縮小
- **行動空間**: 大幅に縮小

### 収束性の向上
- **探索効率**: 限定された選択肢で効率的な探索
- **学習速度**: 小規模環境での高速学習
- **安定性**: 少ない変数での安定した学習

## 設定詳細

### config_area3.yamlの主要設定

```yaml
# エリア制限
data:
  area_restriction:
    enabled: true
    area_name: "第三方面"
    districts: ["目黒区", "渋谷区", "世田谷区"]
    section_code: 3

# PPOパラメータ（第3方面最適化）
ppo:
  n_episodes: 3000
  batch_size: 64
  learning_rate:
    actor: 0.0003
    critic: 0.0005
  entropy_coef: 0.08  # 探索を増やす

# ネットワーク構造（小規模環境向け）
network:
  actor:
    hidden_layers: [128, 64]
  critic:
    hidden_layers: [128, 64]
```

## トラブルシューティング

### 1. データが見つからない
```
❌ 救急事案データファイルが見つかりません
```
**解決策**: `data_cache.py`の`possible_paths`を確認し、実際のファイルパスを追加

### 2. 第3方面の救急車がゼロ台
```
警告: 第3方面の救急車が見つかりません。全体を使用します。
```
**解決策**: `amb_place_master.csv`の`section`カラムを確認

### 3. 事案数が少なすぎる
```
第3方面の1週間データ: 0件
```
**解決策**: `hanso_special_wards.csv`の`出場先区市`カラムを確認

## 次のステップ

1. **第3方面での学習成功**
   - 6分達成率の向上確認
   - 収束の安定性確認

2. **段階的拡張**
   - 隣接方面への拡張
   - 複数方面の同時学習

3. **全23区への展開**
   - 学習済みモデルの転移学習
   - 全体最適化

## 参考情報

- 東京消防庁の組織構造
- 第3方面本部の管轄区域
- PPOアルゴリズムの特性
- 救急システムの運用実態
